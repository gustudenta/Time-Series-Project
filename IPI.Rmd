---
title: "Industrial Production Index"
author: "Qian Yi"
date: "4/12/2020"
output: html_document
---
```{r}
library(dplyr)
library(fGarch) 
library(dynlm)
library(tseries)
library(astsa) 
library(xts)
library(fpp)
library(TSA)
library(forecast)
library(dplR)
library(tseries)

```

# Read the dataset 
```{r}
ifs <- read.csv("IFS.csv",stringsAsFactors =FALSE)
colnames(ifs)=c("Country_Name", "Country_Code", "Indicator_Name", "Indicator_Code", "Time_Period", "Value", "Status")

# remove Status column 
ifs=ifs[, c(1:6)]

# take a look at the dataset 
head(ifs)
# dim(ifs)
print(colnames(ifs))
```

################################################## United　States##############################################################
# Research Indicator: Economic Activity, Industrial Production, Index
# Indicator Code: AIP_IX
# Country: USA 
```{r}
df1_us=subset(ifs, (Indicator_Code=='AIP_IX') & (Country_Name=='United States'))
```

# now the time didn't apear as ascending order 

```{r}

df1_us$Time_Period <- gsub("M", "/", df1_us$Time_Period)

df1_us['date'] = '/01'
df1_us$Time_Period <- paste(df1_us$Time_Period, df1_us$date,  sep="")

df1_us$Time_Period = as.Date(df1_us$Time_Period, "%Y/%m/%d")

df1_us = df1_us[order(df1_us$Time_Period),]
df1_us = subset(df1_us, select = -c(date))
rownames(df1_us)=NULL
```


# Only keep value and Time_Period 
```{r}
# Research Indicator: Economic Activity, Industrial Production, Index
# Indicator Code: AIP_IX
# Country: USA 

# the original data 
df11=ts(df1_us$Value, frequency = 12, start = c(1980, 1))
plot(df11, main="United States: Industrial Production Index", xlab='year', ylab='US IPI')
```

# (1) decompose Analysis
```{r}
plot(decompose(df11))
```

# (2) Spectral Analysis 
```{r}
sp=spectrum(df11, log='no') 

# find the cycle with predominant frequecny 
sp$fre[which.max(sp$spec)] #  0.025

# find the cycle of predominant frequecny 
1/sp$fre[which.max(sp$spec)] # 40 month


max(sp$spec) #estimate of spectral density at predominant period which is close to 326.3907.

U = qchisq(.025,2)
L = qchisq(.975,2)

2*max(sp$spec)/L #lower bound for spectral density
2*max(sp$spec)/U #upper bound for spectral density

# The 95% confidence interval is [88.47962, 12891.74]

```

# (3) ARIMA model 
```{r}
fit1 <- auto.arima(df11, trace = TRUE) #  Best model: ARIMA(4,0,1)(2,1,1)[12] with drift # AIC:  1022.693
```

# evaluate the model
```{r}
sarima(df11, 4,0,1,2,1,1,12) # accoring to the disgnose plots, the model is a good fit 
```

# fit ARIMA by hand 
```{r}
plot(diff(df11)) # d=1
acf(diff(df11), lag.max=200) # MA:q= 0
pacf(diff(df11), lag.max=200) # AR:p= 4,5
# try ARIMA(4,0,1)
fit1.1 <- Arima(df11, order=c(4, 1, 1), seasonal=c(0,1,0), method="ML",include.drift = TRUE)
summary(fit1.1)
checkresiduals(fit1.1)
# AIC=1178.83   AICc=1179.02   BIC=1203.68
fit1.2 <- Arima(df11, order=c(5, 0, 1), seasonal=c(0,1,0), method="ML",include.drift = TRUE)
summary(fit1.2)
checkresiduals(fit1.2)
# AIC=1157.57   AICc=1157.89   BIC=1190.73

# comparing the by hand models with ARIMA(4,0,1)(2,1,1)[12], the ARIMA(4,0,1)(2,1,1)[12] fits better

```





# Use ARIMA model to predict future index 
```{r}
pred1=forecast(fit1,h=48)
pred1 # The last 2 columns are 95% prediction intervals lower bound and upper bound 
autoplot(pred1) #plot with confidence interval 
```

# (4) ARCH/GARCH model

```{r}
# fit ARIMA model without seasonal term 
fit2=auto.arima(df11,  seasonal = FALSE, trace = TRUE) # ARIMA(2,1,2)
```


```{r}

df11.diff=diff(df11)
plot(df11.diff, main=" diff data") 

df11.log=log(df11)
plot(df11.log, main=" log data")

di11.difflog=diff(log(df11))
plot(di11.difflog, main=" difflog data") 
```


```{r}
acf(di11.difflog, lag.max = 100) # from pacf plot, we could observe the seasonality
pacf(di11.difflog, lag.max = 100)# from pacf plot, AR(1) or AR(2)
```


```{r}
acf2(df11^2) # accoring to pacf plot, ARCH(1) or ARCH(2) model 
```


```{r}
# fit ARIMA(2,1,2) model, then plot the residuals ACF and PACF
arima212=arima(df11, order=c(2,1,2))
residual_arima212=arima212$residuals
acf2(residual_arima212^2)


par(mfrow=c(2,2))
acf(residual_arima212, main="ACF of residuals (US)", lag.max=100)
pacf(residual_arima212, main="PACF of residuals (US)", lag.max=100)
acf(residual_arima212^2, main="ACF of squared residuals (US)", lag.max=100)
pacf(residual_arima212^2, main="PACF of squared residuals (US)", lag.max=100)


```


```{r}
garch_us1=garch(residual_arima212,order=c(3,3),trace=F)
summary(garch_us1)
AIC(garch_us1)
```

```{r}
garch_us2=garch(residual_arima212,order=c(0,3),trace=F) # (q,p) 
summary(garch_us2)
AIC(garch_us2) # the AIC is smaller, so ARCH(3) model is better 
```


################################################## United　Kingdom ##############################################################
# Research Indicator: Economic Activity, Industrial Production, Index
# Indicator Code: AIP_IX
# Country: United Kingdom  
```{r}
df1_uk=subset(ifs, (Indicator_Code=='AIP_IX') & (Country_Name=='United Kingdom'))
head(df1_uk)
dim(df1_uk)
```


# change the format of date

```{r}

df1_uk$Time_Period <- gsub("M", "/", df1_uk$Time_Period)

df1_uk['date'] = '/01'
df1_uk$Time_Period <- paste(df1_uk$Time_Period, df1_uk$date,  sep="")

df1_uk$Time_Period = as.Date(df1_uk$Time_Period, "%Y/%m/%d")

df1_uk = df1_uk[order(df1_uk$Time_Period),]
df1_uk = subset(df1_uk, select = -c(date))
rownames(df1_uk)=NULL
```


# Only keep value and Time_Period 
```{r}
# Research Indicator: Economic Activity, Industrial Production, Index
# Indicator Code: AIP_IX
# Country: USA 

# the original data 
df22=ts(df1_uk$Value, frequency = 12, start = c(1980, 1))
plot(df22, main="United Kingdom: Industrial Production Index")
```

# (1) decompose Analysis
```{r}
plot(decompose(df22))
```

# (2) Spectral Analysis 
```{r}
sp=spectrum(df22, log='no') 

# find the cycle with predominant frequecny 
sp$fre[which.max(sp$spec)] #  0.025

# find the cycle of predominant frequecny 
1/sp$fre[which.max(sp$spec)] # 40 month


max(sp$spec) #estimate of spectral density at predominant period which is close to 841.0988.

U = qchisq(.025,2)
L = qchisq(.975,2)

2*max(sp$spec)/L #lower bound for spectral density
2*max(sp$spec)/U #upper bound for spectral density

# The 95% confidence interval is [228.0093, 33221.63]

```

# (3) ARIMA model 
```{r}
fit22 <- auto.arima(df22, trace = TRUE) #  Best model: ARIMA(5,1,1)(2,1,2)[12] 
```

# evaluate the model
```{r}
sarima(df22, 5,1,1,2,1,2,12) 
```

# fit ARIMA by hand 
```{r}
plot(diff(df22, 3)) # d=1
acf(diff(df22, 3), lag.max=200) # MA:q= 0
pacf(diff(df22, 3), lag.max=200) # AR:p= 1, 2
# try ARIMA(1,1,0)
fit2.1 <- Arima(df22, order=c(1, 1, 0), seasonal=c(0,3,0), method="ML",include.drift = TRUE)
summary(fit2.1)
checkresiduals(fit2.1)
# AIC=3111.38   AICc=3111.4   BIC=3119.54
fit2.2 <- Arima(df22, order=c(2, 1, 0),seasonal=c(0,3,0), method="ML",include.drift = TRUE)
summary(fit2.2)
# AIC=3019.05   AICc=3019.1   BIC=3031.29
checkresiduals(fit2.2)

# comparing the diagnostic plot, the ARIMA(5,1,1)(2,1,2)[12] is better in residual acf
```

# Use ARIMA model to predict future index 
```{r}
pred22=forecast(fit22,h=48)
pred22 # The last 2 columns are 95% prediction intervals lower bound and upper bound 
autoplot(pred22) #plot with confidence interval 
```

# (4) ARCH/GARCH model

```{r}
# fit ARIMA model without seasonal term 
fit3=auto.arima(df22,  seasonal = FALSE, trace = TRUE) # ARIMA(2,1,2)
```


```{r}

df22.diff=diff(df22)
plot(df22.diff, main=" diff data") 

df22.log=log(df22)
plot(df22.log, main=" log data")

di22.difflog=diff(log(df22))
plot(di22.difflog, main=" difflog data")

acf(di22.difflog, lag.max = 100) # from pacf plot, we could observe the seasonality
pacf(di22.difflog, lag.max = 100)# from pacf plot, AR(3) or AR(4)

acf2(df22^2) # accoring to pacf plot, ARCH(4) 

```

```{r}
# fit ARIMA(2,1,2) model, then plot the residuals ACF and PACF
arima212.2=arima(df22, order=c(2,1,2))
residual_arima212.2=arima212.2$residuals

acf2(residual_arima212.2^2)

par(mfrow=c(2,2))
acf(residual_arima212.2, main="ACF of residuals (UK)", lag.max=200)
pacf(residual_arima212.2, main="PACF of residuals (UK)", lag.max=200)
acf(residual_arima212.2^2, main="ACF of squared residuals (UK)", lag.max=200)
pacf(residual_arima212.2^2, main="PACF of squared residuals (UK)", lag.max=200)

```


```{r}
garch_uk1=garch(residual_arima212,order=c(0,7),trace=F)
summary(garch_uk1)
AIC(garch_uk1) # the AIC is smaller, so ARCH(0,7) model is better 
```

```{r}
garch_uk2=garch(residual_arima212,order=c(4,7),trace=F) # (q,p) 
summary(garch_uk2)
AIC(garch_uk2) 
```

########################################## Canada #################################################################################
# Research Indicator: Economic Activity, Industrial Production, Index
# Indicator Code: AIP_IX
# Country: Canada 
```{r}
df1_ca=subset(ifs, (Indicator_Code=='AIP_IX') & (Country_Name=='Canada'))
head(df1_ca)

```


# change the format of date

```{r}

df1_ca$Time_Period <- gsub("M", "/", df1_ca$Time_Period)

df1_ca['date'] = '/01'
df1_ca$Time_Period <- paste(df1_ca$Time_Period, df1_ca$date,  sep="")

df1_ca$Time_Period = as.Date(df1_ca$Time_Period, "%Y/%m/%d")

df1_ca = df1_ca[order(df1_ca$Time_Period),]
df1_ca = subset(df1_ca, select = -c(date))
rownames(df1_ca)=NULL
df1_ca=na.omit(df1_ca)
head(df1_ca)
```


# Only keep value and Time_Period 
```{r}
# Research Indicator: Economic Activity, Industrial Production, Index
# Indicator Code: AIP_IX
# Country: Canada 

# the original data 
df33=ts(df1_ca$Value, frequency = 12, start = c(2000, 1), end=c(2018, 12))
plot(df33, main="Canada: Industrial Production Index")
```

# (1) decompose Analysis
```{r}
plot(decompose(df33))
```

# (2) Spectral Analysis 
```{r}
sp=spectrum(df33, log='no')

# find the cycle with predominant frequecny 
sp$fre[which.max(sp$spec)] #  0.05

# find the cycle of predominant frequecny 
1/sp$fre[which.max(sp$spec)] # 20 month


max(sp$spec) #estimate of spectral density at predominant period which is close to 115.1996.

U = qchisq(.025,2)
L = qchisq(.975,2)

2*max(sp$spec)/L #lower bound for spectral density
2*max(sp$spec)/U #upper bound for spectral density

# The 95% confidence interval is [31.22888, 4550.14]

```

# (3) ARIMA model 
```{r}
fit33 <- auto.arima(df33, trace = TRUE) # Best model: ARIMA(2,1,2)(0,1,1)[12]
```

# evaluate the model
```{r}
sarima(df33, 2,1,2,0,1,1,12) # good fit 
```
# fit ARIMA by hand 
```{r}
plot(diff(df33,4)) # d=1
acf(diff(df33,4), lag.max=200) # MA:q= 0
pacf(diff(df33,4), lag.max=200) # AR:p= 1, 2
# try ARIMA(1,1,0)
fit3.1 <- Arima(df33, order=c(1, 1, 0), seasonal=c(0,4,0), method="ML",include.drift = TRUE)
summary(fit3.1)
checkresiduals(fit3.1)
# AIC=3111.38   AICc=3111.4   BIC=3119.54
fit3.2 <- Arima(df33, order=c(2, 1, 0),seasonal=c(0,4,0), method="ML",include.drift = TRUE)
summary(fit3.2)
# AIC=3019.05   AICc=3019.1   BIC=3031.29
checkresiduals(fit3.2)
```


# Use ARIMA model to predict future index 
```{r}
pred33=forecast(fit33,h=48)
pred33 # The last 2 columns are 95% prediction intervals lower bound and upper bound 
autoplot(pred33) #plot with confidence interval 
```

# (4) ARCH/GARCH model

```{r}
# fit ARIMA model without seasonal term 
fit4=auto.arima(df33,  seasonal = FALSE, trace = TRUE) # ARIMA(1,1,2)
```


```{r}

df33.diff=diff(df33)
plot(df33.diff, main=" diff data") 

df33.log=log(df33)
plot(df33.log, main=" log data")

di33.difflog=diff(log(df33))
plot(di33.difflog, main=" difflog data")

acf(di33.difflog, lag.max = 100) # from pacf plot, we could observe the seasonality
pacf(di33.difflog, lag.max = 100)# from pacf plot, AR(2) or AR(4)

acf2(df33^2) # accoring to pacf plot, ARCH(2) 

```

```{r}
# fit ARIMA(1,1,2) model, then plot the residuals ACF and PACF
arima112=arima(df33, order=c(1,1,2))
residual_arima112=arima112$residuals
acf2(residual_arima112^2)

par(mfrow=c(2,2))
acf(residual_arima112, main="ACF of residuals (Canada)", lag.max=100)
pacf(residual_arima112, main="PACF of residuals (Canada)", lag.max=100)
acf(residual_arima112^2, main="ACF of squared residuals (Canada)", lag.max=100)
pacf(residual_arima112^2, main="PACF of squared residuals (Canada)", lag.max=100)

```


```{r}
garch_ca1=garch(residual_arima212,order=c(6,1),trace=F)
summary(garch_ca1)
AIC(garch_ca1) 
```

```{r}
garch_ca2=garch(residual_arima112,order=c(6,2),trace=F) # (q,p) # AIC is smaller 
summary(garch_ca2)
AIC(garch_ca2) # the AIC is smaller, so GARCH(6,2) model is better 
```















